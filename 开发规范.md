# SquadFile 开发规范文档

## 1. 代码规范

### 1.1 C# 代码规范

#### 1.1.1 命名约定
```csharp
// 类名：PascalCase
public class UserService { }
public class FileController { }

// 接口名：I + PascalCase
public interface IUserService { }
public interface IFileRepository { }

// 方法名：PascalCase
public async Task<User> GetUserByIdAsync(int userId) { }
public void ProcessFile(FileInfo fileInfo) { }

// 属性：PascalCase
public string UserName { get; set; }
public int FileSize { get; set; }

// 字段：camelCase（私有），PascalCase（公有）
private readonly IUserService _userService;
private string _internalCache;
public static readonly string DefaultPath = "/uploads";

// 参数和局部变量：camelCase
public void CreateUser(string userName, string email)
{
    var newUser = new User();
    var userId = GenerateId();
}

// 常量：PascalCase
public const int MaxFileSize = 1048576;
public static readonly TimeSpan TokenExpiry = TimeSpan.FromHours(1);

// 枚举：PascalCase
public enum UserRole
{
    Admin,
    Manager,
    Member
}
```

#### 1.1.2 代码格式
```csharp
// 大括号：换行风格
public class UserService
{
    public async Task<User> CreateUserAsync(CreateUserRequest request)
    {
        if (request == null)
        {
            throw new ArgumentNullException(nameof(request));
        }

        // 业务逻辑
        return user;
    }
}

// 属性：表达式主体
public string FullName => $"{FirstName} {LastName}";
public bool IsActive { get; set; } = true;

// LINQ：多行格式
var activeUsers = await _context.Users
    .Where(u => u.IsActive)
    .OrderBy(u => u.CreatedTime)
    .Select(u => new UserDto
    {
        Id = u.Id,
        Name = u.Name,
        Email = u.Email
    })
    .ToListAsync();

// 字符串插值优于连接
var message = $"User {userName} uploaded file {fileName}";

// using声明
using var fileStream = File.OpenRead(filePath);
```

#### 1.1.3 注释规范
```csharp
/// <summary>
/// 用户服务，处理用户相关业务逻辑
/// </summary>
public class UserService : IUserService
{
    /// <summary>
    /// 根据用户ID获取用户信息
    /// </summary>
    /// <param name="userId">用户ID</param>
    /// <returns>用户信息，如果不存在返回null</returns>
    /// <exception cref="ArgumentException">当userId小于等于0时抛出</exception>
    public async Task<User?> GetUserByIdAsync(int userId)
    {
        // TODO: 添加缓存机制
        if (userId <= 0)
        {
            throw new ArgumentException("用户ID必须大于0", nameof(userId));
        }

        // 从数据库查询用户
        return await _userRepository.GetByIdAsync(userId);
    }

    // HACK: 临时解决方案，等待API升级
    // FIXME: 处理并发访问问题
    // NOTE: 这里使用了特殊的算法优化性能
}
```

### 1.2 JavaScript/TypeScript 代码规范

#### 1.2.1 命名约定
```javascript
// 变量和函数：camelCase
const userName = 'admin';
const userList = [];
function getUserById(userId) { }
const createUser = async (userData) => { };

// 类名：PascalCase
class UserService { }
class FileUploader { }

// 常量：UPPER_SNAKE_CASE
const MAX_FILE_SIZE = 1024 * 1024;
const API_BASE_URL = '/api/v1';

// 私有属性：前缀下划线
class UserService {
  #privateField = 'private';
  _internalCache = new Map();
  
  constructor() {
    this.publicProperty = 'public';
  }
}
```

#### 1.2.2 代码格式
```javascript
// 对象和数组：多行格式
const userConfig = {
  name: 'admin',
  email: 'admin@example.com',
  permissions: ['read', 'write'],
  settings: {
    theme: 'dark',
    language: 'zh-Hans'
  }
};

const fileTypes = [
  'image/jpeg',
  'image/png',
  'application/pdf',
  'text/plain'
];

// 函数：箭头函数优于function声明
const processFiles = async (files) => {
  return files
    .filter(file => file.size > 0)
    .map(file => ({
      name: file.name,
      size: file.size,
      type: file.type
    }));
};

// 解构赋值
const { name, email, role } = user;
const [first, second, ...rest] = items;

// 模板字符串
const message = `用户 ${userName} 上传了 ${fileCount} 个文件`;

// 可选链
const fileSize = user?.profile?.files?.[0]?.size ?? 0;
```

#### 1.2.3 TypeScript 类型定义
``typescript
// 接口定义
interface User {
  id: number;
  name: string;
  email: string;
  role: UserRole;
  createdAt: Date;
  profile?: UserProfile;
}

interface UserProfile {
  avatar?: string;
  bio?: string;
  settings: UserSettings;
}

// 类型别名
type UserRole = 'admin' | 'manager' | 'member';
type FileType = 'image' | 'document' | 'video' | 'audio';

// 泛型
interface ApiResponse<T> {
  code: number;
  message: string;
  data: T;
  timestamp: string;
}

// 实用类型
type CreateUserRequest = Omit<User, 'id' | 'createdAt'>;
type UpdateUserRequest = Partial<Pick<User, 'name' | 'email'>>;

// 函数类型
type EventHandler<T> = (event: T) => void;
type AsyncValidator<T> = (value: T) => Promise<boolean>;
```

## 2. 测试策略

### 2.1 测试金字塔

```
       /\
      /  \
     / UI \     <- 少量UI测试（10%）
    /______\
   /        \
  / 集成测试  \   <- 适量集成测试（20%）
 /____________\
/              \
/   单元测试    \  <- 大量单元测试（70%）
/________________\
```

### 2.2 单元测试规范

#### 2.2.1 测试命名
```csharp
// 命名模式：MethodName_StateUnderTest_ExpectedBehavior
[Test]
public async Task CreateUser_WithValidData_ShouldReturnUser()
{
    // Arrange
    var request = new CreateUserRequest
    {
        UserName = "testuser",
        Email = "test@example.com"
    };

    // Act
    var result = await _userService.CreateUserAsync(request);

    // Assert
    result.Should().NotBeNull();
    result.UserName.Should().Be("testuser");
    result.Email.Should().Be("test@example.com");
}

[Test]
public async Task CreateUser_WithDuplicateEmail_ShouldThrowException()
{
    // Arrange
    var request = new CreateUserRequest
    {
        UserName = "testuser",
        Email = "existing@example.com"
    };

    // Act & Assert
    await FluentActions
        .Invoking(() => _userService.CreateUserAsync(request))
        .Should()
        .ThrowAsync<BusinessException>()
        .WithMessage("邮箱已存在");
}
```

#### 2.2.2 Mock使用
```csharp
[SetUp]
public void Setup()
{
    _userRepository = new Mock<IUserRepository>();
    _emailService = new Mock<IEmailService>();
    _logger = new Mock<ILogger<UserService>>();
    
    _userService = new UserService(
        _userRepository.Object,
        _emailService.Object,
        _logger.Object);
}

[Test]
public async Task CreateUser_ShouldCallRepository()
{
    // Arrange
    var request = new CreateUserRequest { UserName = "test", Email = "test@example.com" };
    var expectedUser = new User { Id = 1, UserName = "test", Email = "test@example.com" };
    
    _userRepository
        .Setup(r => r.CreateAsync(It.IsAny<User>()))
        .ReturnsAsync(expectedUser);

    // Act
    await _userService.CreateUserAsync(request);

    // Assert
    _userRepository.Verify(r => r.CreateAsync(It.Is<User>(u => 
        u.UserName == "test" && u.Email == "test@example.com")), Times.Once);
}
```

### 2.3 集成测试规范

#### 2.3.1 API集成测试
```csharp
[TestFixture]
public class UserControllerIntegrationTests : IntegrationTestBase
{
    [Test]
    public async Task CreateUser_WithValidData_ShouldReturn201()
    {
        // Arrange
        var request = new CreateUserRequest
        {
            UserName = "testuser",
            Email = "test@example.com",
            Role = "Member"
        };

        // Act
        var response = await Client.PostAsJsonAsync("/api/v1/users", request);

        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.Created);
        
        var content = await response.Content.ReadAsStringAsync();
        var result = JsonSerializer.Deserialize<ApiResponse<UserResponse>>(content);
        
        result.Code.Should().Be(200);
        result.Data.UserName.Should().Be("testuser");
    }
}

public class IntegrationTestBase
{
    protected HttpClient Client { get; private set; }
    protected WebApplicationFactory<Program> Factory { get; private set; }

    [OneTimeSetUp]
    public void OneTimeSetUp()
    {
        Factory = new WebApplicationFactory<Program>()
            .WithWebHostBuilder(builder =>
            {
                builder.ConfigureServices(services =>
                {
                    // 替换为测试数据库
                    services.RemoveAll<DbContext>();
                    services.AddDbContext<ApplicationDbContext>(options =>
                        options.UseInMemoryDatabase("TestDb"));
                });
            });

        Client = Factory.CreateClient();
    }
}
```

### 2.4 前端测试规范

#### 2.4.1 Vue组件测试
```
// FileList.spec.js
import { mount } from '@vue/test-utils';
import { createPinia } from 'pinia';
import FileList from '@/components/file/FileList.vue';

describe('FileList', () => {
  let wrapper;
  let pinia;

  beforeEach(() => {
    pinia = createPinia();
    wrapper = mount(FileList, {
      global: {
        plugins: [pinia]
      },
      props: {
        folderId: 1
      }
    });
  });

  it('should render file list', () => {
    expect(wrapper.find('.file-list').exists()).toBe(true);
  });

  it('should emit file-select when file clicked', async () => {
    const fileItem = wrapper.find('.file-item');
    await fileItem.trigger('click');
    
    expect(wrapper.emitted('file-select')).toBeTruthy();
    expect(wrapper.emitted('file-select')[0]).toEqual([{ id: 1 }]);
  });

  it('should show loading state', async () => {
    wrapper.vm.loading = true;
    await wrapper.vm.$nextTick();
    
    expect(wrapper.find('.loading').exists()).toBe(true);
  });
});
```

#### 2.4.2 API服务测试
```
// userService.spec.js
import { userService } from '@/services/user';
import { http } from '@/services/http';

jest.mock('@/services/http');

describe('userService', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('should get user by id', async () => {
    const mockUser = { id: 1, name: 'Test User' };
    http.get.mockResolvedValue({ data: mockUser });

    const result = await userService.getUserById(1);

    expect(http.get).toHaveBeenCalledWith('/api/v1/users/1');
    expect(result).toEqual(mockUser);
  });

  it('should handle api error', async () => {
    http.get.mockRejectedValue(new Error('Network Error'));

    await expect(userService.getUserById(1))
      .rejects
      .toThrow('Network Error');
  });
});
```

## 3. 代码质量

### 3.1 静态代码分析

#### 3.1.1 C# 分析器配置
```
<!-- .editorconfig -->
root = true

[*.cs]
# 缩进
indent_style = space
indent_size = 4

# 换行
end_of_line = crlf
insert_final_newline = true

# 代码分析规则
dotnet_analyzer_diagnostic.CA1001.severity = error  # 类型拥有可释放字段
dotnet_analyzer_diagnostic.CA1031.severity = warning # 不要捕获一般异常类型
dotnet_analyzer_diagnostic.CA2007.severity = none   # 不强制使用ConfigureAwait

# StyleCop规则
dotnet_diagnostic.SA1633.severity = none  # 文件头注释
dotnet_diagnostic.SA1200.severity = error # using应在命名空间内
```

#### 3.1.2 ESLint配置
```
// .eslintrc.js
module.exports = {
  env: {
    browser: true,
    es2021: true,
    node: true
  },
  extends: [
    'eslint:recommended',
    '@vue/typescript/recommended',
    '@vue/prettier'
  ],
  rules: {
    // 错误级别
    'no-console': process.env.NODE_ENV === 'production' ? 'error' : 'warn',
    'no-debugger': process.env.NODE_ENV === 'production' ? 'error' : 'warn',
    'no-unused-vars': 'error',
    
    // 代码风格
    'prefer-const': 'error',
    'no-var': 'error',
    'object-shorthand': 'error',
    'prefer-template': 'error',
    
    // Vue特定规则
    'vue/component-name-in-template-casing': ['error', 'PascalCase'],
    'vue/prop-name-casing': ['error', 'camelCase'],
    'vue/attribute-hyphenation': ['error', 'always']
  }
};
```

### 3.2 代码覆盖率

#### 3.2.1 目标覆盖率
- **单元测试**: ≥ 80%
- **集成测试**: ≥ 60%
- **关键业务逻辑**: ≥ 90%

#### 3.2.2 覆盖率配置
```
<!-- coverlet.runsettings -->
<?xml version="1.0" encoding="utf-8" ?>
<RunSettings>
  <DataCollectionRunSettings>
    <DataCollectors>
      <DataCollector friendlyName="XPlat code coverage">
        <Configuration>
          <Format>cobertura</Format>
          <Exclude>
            <ExcludeByFile>**/Program.cs</ExcludeByFile>
            <ExcludeByFile>**/Startup.cs</ExcludeByFile>
            <ExcludeByAttribute>ExcludeFromCodeCoverage</ExcludeByAttribute>
          </Exclude>
        </Configuration>
      </DataCollector>
    </DataCollectors>
  </DataCollectionRunSettings>
</RunSettings>
```

## 4. Git工作流

### 4.1 分支策略

```
main
├─ develop
│  ├─ feature/user-management
│  ├─ feature/file-upload
│  └─ feature/permission-system
├─ release/v1.0.0
└─ hotfix/critical-bug-fix
```

### 4.2 提交规范

#### 4.2.1 提交消息格式
```
type(scope): subject

body

footer
```

**类型（type）**:
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式（不影响功能）
- `refactor`: 重构代码
- `perf`: 性能优化
- `test`: 测试相关
- `chore`: 构建过程或辅助工具变动

**作用域（scope）**:
- `auth`: 认证相关
- `file`: 文件管理
- `user`: 用户管理
- `share`: 分享功能
- `ui`: 用户界面
- `api`: API接口

#### 4.2.2 提交示例
```
feat(file): add chunk upload support

Implement chunk upload functionality to support large file uploads:
- Add ChunkUploadService with progress tracking
- Add resumable upload capability
- Add upload session management

Breaking change: Upload API now requires session initialization

Closes #123
Refs #124
```

### 4.3 代码审查

#### 4.3.1 Pull Request模板
```
## 变更说明
简要描述这次变更的内容和原因

## 变更类型
- [ ] 新功能
- [ ] Bug修复
- [ ] 重构
- [ ] 文档更新
- [ ] 性能优化

## 测试情况
- [ ] 单元测试已通过
- [ ] 集成测试已通过
- [ ] 手动测试已完成

## 检查清单
- [ ] 代码遵循项目规范
- [ ] 已添加必要的注释
- [ ] 已更新相关文档
- [ ] 无安全隐患

## 相关Issue
Closes #xxx
Refs #xxx
```

#### 4.3.2 审查要点
1. **功能正确性**: 代码是否实现了预期功能
2. **代码质量**: 是否遵循编码规范和最佳实践
3. **性能影响**: 是否存在性能问题
4. **安全考虑**: 是否存在安全漏洞
5. **测试覆盖**: 是否有足够的测试覆盖
6. **文档完整**: 是否更新了相关文档

## 5. 性能优化

### 5.1 后端性能

#### 5.1.1 数据库优化
```csharp
// 使用异步方法
public async Task<List<File>> GetFilesByFolderAsync(int folderId)
{
    return await _context.Files
        .Where(f => f.FolderId == folderId && f.DeletedTime == null)
        .Include(f => f.Owner)
        .OrderBy(f => f.Name)
        .ToListAsync();
}

// 分页查询
public async Task<PagedResult<File>> GetFilesPagedAsync(int folderId, int page, int size)
{
    var query = _context.Files
        .Where(f => f.FolderId == folderId && f.DeletedTime == null);
    
    var total = await query.CountAsync();
    var items = await query
        .Skip((page - 1) * size)
        .Take(size)
        .ToListAsync();
    
    return new PagedResult<File>(items, total, page, size);
}

// 使用投影减少数据传输
public async Task<List<FileListItem>> GetFileListAsync(int folderId)
{
    return await _context.Files
        .Where(f => f.FolderId == folderId)
        .Select(f => new FileListItem
        {
            Id = f.Id,
            Name = f.Name,
            Size = f.Size,
            CreatedTime = f.CreatedTime
        })
        .ToListAsync();
}
```

#### 5.1.2 缓存策略
```csharp
public class UserService : IUserService
{
    private readonly ICacheService _cache;
    private const string USER_CACHE_KEY = "user:{0}";
    private static readonly TimeSpan CacheExpiry = TimeSpan.FromMinutes(30);

    public async Task<User> GetUserByIdAsync(int userId)
    {
        var cacheKey = string.Format(USER_CACHE_KEY, userId);
        
        return await _cache.GetOrSetAsync(
            cacheKey,
            async () => await _userRepository.GetByIdAsync(userId),
            CacheExpiry);
    }

    public async Task UpdateUserAsync(int userId, UpdateUserRequest request)
    {
        await _userRepository.UpdateAsync(userId, request);
        
        // 清除缓存
        var cacheKey = string.Format(USER_CACHE_KEY, userId);
        await _cache.RemoveAsync(cacheKey);
    }
}
```

### 5.2 前端性能

#### 5.2.1 组件懒加载
```
// 路由懒加载
const routes = [
  {
    path: '/files',
    component: () => import('@/pages/files/list.vue')
  },
  {
    path: '/admin',
    component: () => import('@/pages/admin/dashboard.vue')
  }
];

// 组件懒加载
export default {
  components: {
    FilePreview: () => import('@/components/file/FilePreview.vue')
  }
};
```

#### 5.2.2 虚拟滚动
```
<template>
  <RecycleScroller
    class="file-list"
    :items="files"
    :item-size="60"
    key-field="id"
    v-slot="{ item }"
  >
    <FileItem :file="item" />
  </RecycleScroller>
</template>

<script>
import { RecycleScroller } from 'vue-virtual-scroller';

export default {
  components: {
    RecycleScroller
  },
  props: {
    files: Array
  }
};
</script>
```

## 6. 安全规范

### 6.1 输入验证
```
public class CreateUserRequestValidator : AbstractValidator<CreateUserRequest>
{
    public CreateUserRequestValidator()
    {
        RuleFor(x => x.UserName)
            .NotEmpty().WithMessage("用户名不能为空")
            .Length(3, 20).WithMessage("用户名长度必须在3-20个字符之间")
            .Matches("^[a-zA-Z0-9_]+$").WithMessage("用户名只能包含字母、数字和下划线");

        RuleFor(x => x.Email)
            .NotEmpty().WithMessage("邮箱不能为空")
            .EmailAddress().WithMessage("邮箱格式不正确");

        RuleFor(x => x.Password)
            .NotEmpty().WithMessage("密码不能为空")
            .MinimumLength(8).WithMessage("密码至少8位")
            .Matches(@"^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)")
            .WithMessage("密码必须包含大小写字母和数字");
    }
}
```

### 6.2 SQL注入防护
```
// 使用参数化查询
public async Task<List<User>> SearchUsersAsync(string keyword)
{
    return await _context.Users
        .Where(u => u.UserName.Contains(keyword) || u.Email.Contains(keyword))
        .ToListAsync();
}

// 使用FromSqlRaw时必须参数化
public async Task<List<User>> GetUsersByDepartmentAsync(string department)
{
    return await _context.Users
        .FromSqlRaw("SELECT * FROM Users WHERE Department = {0}", department)
        .ToListAsync();
}
```

### 6.3 XSS防护
```
// 输出编码
const sanitizeHtml = (html) => {
  const div = document.createElement('div');
  div.textContent = html;
  return div.innerHTML;
};

// Vue自动转义
<template>
  <!-- 安全：自动转义 -->
  <div>{{ userInput }}</div>
  
  <!-- 危险：原始HTML -->
  <div v-html="trustedHtml"></div>
</template>
```

这套开发规范确保了SquadFile项目的代码质量、可维护性和安全性，为团队协作提供了统一的标准。